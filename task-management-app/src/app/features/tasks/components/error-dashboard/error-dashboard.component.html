<div class="error-dashboard">
  <mat-card class="dashboard-header">
    <mat-card-header>
      <mat-card-title>エラー分析ダッシュボード</mat-card-title>
      <mat-card-subtitle>過去30日間のエラー分析</mat-card-subtitle>
    </mat-card-header>
    <mat-card-actions>
      <button mat-button (click)="refresh()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        更新
      </button>
      <button mat-button (click)="generateReport()" [disabled]="loading">
        <mat-icon>description</mat-icon>
        レポート生成
      </button>
    </mat-card-actions>
  </mat-card>

  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
  </div>

  <div class="error-message" *ngIf="error">
    <mat-icon color="warn">error</mat-icon>
    {{ error }}
  </div>

  <div class="dashboard-content" *ngIf="!loading && !error && errorAnalysis">
    <!-- 概要カード -->
    <mat-card class="summary-card">
      <mat-card-content>
        <div class="summary-item">
          <div class="summary-label">総エラー数</div>
          <div class="summary-value">{{ errorAnalysis.totalErrors }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">エラータイプ数</div>
          <div class="summary-value">{{ Object.keys(errorAnalysis.errorTypes).length }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- 最も頻繁なエラー -->
    <mat-card class="common-errors-card">
      <mat-card-header>
        <mat-card-title>頻出エラー</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="errorAnalysis.mostCommonErrors">
          <ng-container matColumnDef="errorCode">
            <th mat-header-cell *matHeaderCellDef>エラーコード</th>
            <td mat-cell *matCellDef="let error">{{ error.errorCode }}</td>
          </ng-container>

          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>発生回数</th>
            <td mat-cell *matCellDef="let error">
              {{ error.count }}
              <span class="error-rate">({{ calculateErrorRate(error.count) }})</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="lastOccurrence">
            <th mat-header-cell *matHeaderCellDef>最終発生</th>
            <td mat-cell *matCellDef="let error">{{ formatDate(error.lastOccurrence) }}</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>アクション</th>
            <td mat-cell *matCellDef="let error">
              <button mat-icon-button color="primary" 
                      (click)="showErrorDetails(error.errorCode)"
                      matTooltip="エラー詳細を表示">
                <mat-icon>info</mat-icon>
              </button>
              <button mat-icon-button color="accent"
                      (click)="openFeedbackDialog(error)"
                      matTooltip="フィードバックを送信">
                <mat-icon>feedback</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- 最近のエラー -->
    <mat-card class="recent-errors-card">
      <mat-card-header>
        <mat-card-title>最近のエラー</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="errorAnalysis.recentErrors">
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef>発生時刻</th>
            <td mat-cell *matCellDef="let error">{{ formatDate(error.timestamp) }}</td>
          </ng-container>

          <ng-container matColumnDef="errorCode">
            <th mat-header-cell *matHeaderCellDef>エラーコード</th>
            <td mat-cell *matCellDef="let error">{{ error.errorCode }}</td>
          </ng-container>

          <ng-container matColumnDef="errorMessage">
            <th mat-header-cell *matHeaderCellDef>エラーメッセージ</th>
            <td mat-cell *matCellDef="let error">{{ error.errorMessage }}</td>
          </ng-container>

          <ng-container matColumnDef="userId">
            <th mat-header-cell *matHeaderCellDef>ユーザーID</th>
            <td mat-cell *matCellDef="let error">{{ error.userId || '-' }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="recentErrorColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: recentErrorColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- ユーザー影響度 -->
    <mat-card class="user-impact-card">
      <mat-card-header>
        <mat-card-title>ユーザー影響度</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="errorAnalysis.userImpact">
          <ng-container matColumnDef="userId">
            <th mat-header-cell *matHeaderCellDef>ユーザーID</th>
            <td mat-cell *matCellDef="let impact">{{ impact.userId }}</td>
          </ng-container>

          <ng-container matColumnDef="errorCount">
            <th mat-header-cell *matHeaderCellDef>エラー数</th>
            <td mat-cell *matCellDef="let impact">{{ impact.errorCount }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['userId', 'errorCount']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['userId', 'errorCount'];"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>
</div> 